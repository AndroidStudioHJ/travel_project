{% extends 'base.html' %}
{% load static %}

{% block title %}블로그 감성 분석{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
    /* Pretendard 폰트 임포트 */
    @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.6/dist/web/static/pretendard.css');

    .sentiment-results-text {
        font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
        /* 폰트 렌더링 최적화 속성 */
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        text-rendering: optimizeLegibility;
    }

    .sentiment-container {
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .sentiment-header {
        text-align: center;
        margin-bottom: 30px;
    }

    .sentiment-form {
        max-width: 600px;
        margin: 0 auto;
        display: flex;
        justify-content: center;
    }

    .search-input-group {
        display: flex;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        overflow: hidden;
        width: 100%;
        max-width: 400px;
    }

    .search-input-group .form-control {
        border: none;
        box-shadow: none;
        flex-grow: 1;
        padding-left: 0.75rem;
    }

    .search-input-group .btn-primary {
        border: none;
        background-color: #007bff;
        color: white;
        cursor: pointer;
        padding: 0.375rem 0.75rem;
        flex-shrink: 0;
    }

    .sentiment-form .input-group > .form-control:not(:first-child),
    .sentiment-form .input-group > .btn:not(:first-child):not(:last-child) {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
    }
    .sentiment-form .input-group > .btn:not(:last-child):not(:first-child) {
         border-top-right-radius: 0;
        border-bottom-right-radius: 0;
    }
     .sentiment-form .input-group > .form-control + .btn {
         border-left: none;
     }

    .sentiment-results {
        margin-top: 30px;
    }

    .sentiment-card {
        margin-bottom: 20px;
        border: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        width: 100%;
    }

    .sentiment-card .card-header {
        font-weight: bold;
        padding: 15px;
        font-size: 1.1rem;
    }

    .sentiment-card .card-body {
        padding: 25px;
    }

    .sentiment-stats {
        display: flex;
        justify-content: space-around;
        margin-bottom: 20px;
        text-align: center;
        flex-wrap: wrap;
    }

    .stat-item {
        flex-grow: 1;
        padding: 15px;
        border-radius: 5px;
        background-color: rgba(0,0,0,0.05);
        min-width: 120px;
        margin: 5px;
    }

    .stat-item h5 {
        margin-bottom: 5px;
        font-size: 1.1rem;
    }

    .stat-item p {
        margin-bottom: 0;
        font-size: 1.3rem;
        font-weight: bold;
    }

    .sentiment-card .card-body h6 {
        margin-bottom: 8px;
        font-size: 1.05rem;
    }

    .sentiment-card .card-body a {
        word-break: break-all;
        font-size: 1rem;
    }

    .positive { color: #28a745; }
    .negative { color: #dc3545; }
    .neutral { color: #6c757d; }
    
    .sentiment-filters {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
        gap: 15px;
    }
    
    .sentiment-filters a {
        text-decoration: none;
        padding: 8px 15px;
        border-radius: 4px;
        transition: background-color 0.3s ease;
        color: #007bff;
        border: 1px solid #007bff;
    }
    
    .sentiment-filters a.active {
        background-color: #007bff;
        color: white;
    }

</style>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="sentiment-container">
        <div class="sentiment-header sentiment-results-text">
            <h1 class="mb-4">네이버 블로그 감성 분석</h1>
        </div>
        
        <form method="get" class="sentiment-form sentiment-results-text">
            <div class="input-group search-input-group">
                <input type="text" name="query" class="form-control" placeholder="검색어를 입력하세요" value="{{ query|default:'' }}">
                <button type="submit" class="btn btn-primary">분석하기</button>
            </div>
        </form>

        {% if query %}
            <div class="sentiment-results sentiment-results-text">
                <div class="sentiment-stats">
                    <div class="stat-item">
                        <h5>전체 후기</h5>
                        <p>{{ total_count }}개</p>
                    </div>
                    <div class="stat-item positive">
                        <h5>긍정 후기</h5>
                        <p>{{ positive_count }}개</p>
                    </div>
                    <div class="stat-item negative">
                        <h5>부정 후기</h5>
                        <p>{{ negative_count }}개</p>
                    </div>
                    <div class="stat-item neutral">
                        <h5>중립 후기</h5>
                        <p>{{ neutral_count }}개</p>
                    </div>
                </div>

                <div class="sentiment-filters">
                    <a href="#" class="sentiment-filter {% if not selected_sentiment %}active{% endif %}" data-sentiment="">전체 보기</a>
                    <a href="#" class="sentiment-filter {% if selected_sentiment == 'positive' %}active{% endif %}" data-sentiment="positive">긍정적 리뷰</a>
                    <a href="#" class="sentiment-filter {% if selected_sentiment == 'neutral' %}active{% endif %}" data-sentiment="neutral">중립적 리뷰</a>
                    <a href="#" class="sentiment-filter {% if selected_sentiment == 'negative' %}active{% endif %}" data-sentiment="negative">부정적 리뷰</a>
                </div>

                <div id="sentiment-results-container">
                    {% include 'blog/sentiment_results.html' %}
                </div>
            </div>
        {% endif %}
    </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const filterButtons = document.querySelectorAll('.sentiment-filter');
    const resultsContainer = document.getElementById('sentiment-results-container');
    const query = new URLSearchParams(window.location.search).get('query');
    
    // 디바운스 함수
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // 로딩 상태 표시 함수
    function showLoading() {
        resultsContainer.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">로딩중...</span></div></div>';
    }
    
    // 에러 상태 표시 함수
    function showError() {
        resultsContainer.innerHTML = '<div class="alert alert-danger">데이터를 불러오는 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요.</div>';
    }
    
    // AJAX 요청 함수
    const fetchResults = debounce(function(sentiment) {
        showLoading();
        
        fetch(`/blog/sentiment-results/?query=${query}&sentiment=${sentiment}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text();
            })
            .then(html => {
                resultsContainer.innerHTML = html;
            })
            .catch(error => {
                console.error('Error:', error);
                showError();
            });
    }, 300); // 300ms 디바운스

    filterButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            
            // 활성화된 버튼 스타일 변경
            filterButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');

            const sentiment = this.dataset.sentiment;
            fetchResults(sentiment);
        });
    });
});
</script>
{% endblock %}
{% endblock %} 